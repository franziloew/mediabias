---
title: "MediaTenor Data"
output: 
  html_document:
    fig_width: 10
    theme: "lumen"
    highlight: "tango"
    code_folding: show
    self_contained: true
---


```{r message=FALSE, warning=FALSE, include=FALSE}
library(foreign)
library(tidyr)
library(ggplot2)
library(dplyr)
library(lubridate)
library(readr)
library(plotly)
library(scales)

# Theming
quartzFonts(
  Roboto =
    c("Roboto-Light",
      "Roboto-Bold",
      "Roboto-Regular",
      "Roboto-Thin")
)

theme_set(
  theme_bw(base_family = "Roboto", base_size = 10) +
    theme(
      plot.title = element_text(size = 14,
                                margin = margin(0, 0, 4, 0, "pt")),
      plot.subtitle = element_text(size = 8),
      plot.caption = element_text(size = 6),
      plot.background   = element_rect("#fafafa", "#fafafa"),
      panel.background  = element_rect("#fafafa"),
      panel.border = element_blank()
    )
)

rm(list=ls())
```

```{r eval=FALSE, include=FALSE}
library(haven)
pp_1998_2012 <- read_dta("../data/pp_1998-2012.dta")
```

## Prepare Dataframe 
```{r eval=FALSE, include=FALSE}
df <- pp_1998_2012 %>%
  # decode variables
  mutate(p_group = to_character(p_group),
         medium = to_character(medium),
         wertung = as.numeric(remove_labels(wertung)),
         
         #Generate Date-Variable (as.Date function gives NAs)
         date = as.Date(datum, "%Y-%b-%d"),
         month = as.numeric(monat),
         
         # Correct UTF Problems
         medium = factor(ifelse(grepl("ddeutsche", medium), "SZ", medium)),
         p_group = factor(ifelse(grepl("90", p_group), "Bündnis 90/ Die Grüne", p_group))
         )

### Assign category to medium
daily_print <- c("Die Welt", "F.A.Z.", "SZ", "Fr. Rundschau", "tageszeitung", "Bild", "Berliner")
magazine_print <- c("Focus", "Spiegel", "Die Zeit", "Die Woche", "Rh. Merkur", "Stern", "F.A.S.", "WamS", "BamS", "Super Illu")
news_tv <- c("Tagesthemen", "heute journal", "RTL Aktuell", "Tagesschau", "heute", "ProSieben", "Sat.1 News")
polit_tv <- c("Fakt", "Frontal 21", "Kontraste", "Monitor", "Panorama", "Plusminus", "Report (BR)", "Report (SWR)", "WISO", "Bericht aus Berlin", "Berlin direkt")

df <- df %>%
  mutate(category = ifelse(medium %in% daily_print, "daily_print", " "),
         category = ifelse(medium %in% magazine_print, "magazine_print", category),
         category = ifelse(medium %in% news_tv, "news_tv", category),
         category = ifelse(medium %in% polit_tv, "polit_tv", category))

save(df, file = "../output/mediatenorFULLDF.Rda")
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
df.collapsed <- df %>%
  group_by(date, month, medium, p_group, category) %>%
  summarise(obs = n(),
            wertung = mean(wertung, na.rm = T),
            tendenz = mean(tendenz, ra.rm = T),
            kontext = mean(kontext, ra.rm = T)) %>%
  ungroup()

save(df.collapsed, file = "../output/mediatenorCOLLAPSEDDF.Rda")
```

```{r eval=FALSE, include=FALSE}
df.collapsed2 <- df.collapsed %>%
  mutate(year = year(date)) %>%
  # calculate number of obs by medium, p_group, year
  group_by(medium, p_group, year) %>%
  add_tally() %>%
  ungroup() %>%
  mutate(count = n) %>%
  select(-n) %>%
  
  # calculate number of obs by medium, year
  group_by(medium, year) %>%
  add_tally() %>%
  ungroup() %>%
  mutate(sumcount = n) %>%
  select(-n) %>%
  
  # calculate weight
  mutate(weight = count/sumcount) %>%
  
  # calculate weighted values
  mutate(weighted = wertung * weight)
```

```{r eval=FALSE, include=FALSE}
df.reduced <- df.collapsed2 %>% 
  group_by(medium, p_group, year, category) %>%
  summarise(count = n(),
            weighted = mean(weighted),
            wertung = mean(wertung),
            weight = mean(weight)) %>%
  ungroup() 

save(df.reduced, file = "../output/mediatenor.Rda")
```

