---
title: "MediaTenor Data"
output: 
  html_document:
    fig_width: 10
    theme: "lumen"
    highlight: "tango"
    code_folding: show
    self_contained: true
---


```{r message=FALSE, warning=FALSE, include=FALSE}
library(foreign)
library(tidyr)
library(ggplot2)
library(dplyr)
library(lubridate)
library(readr)
library(scales)
library(htmlTable)
library(Hmisc)
library(labelled)
library(lubridate)

# Theming
quartzFonts(
  Roboto =
    c("Roboto-Light",
      "Roboto-Bold",
      "Roboto-Regular",
      "Roboto-Thin")
)

theme_set(
  theme_bw(base_family = "Roboto", base_size = 10) +
    theme(
      plot.title = element_text(size = 14,
                                margin = margin(0, 0, 4, 0, "pt")),
      plot.subtitle = element_text(size = 8),
      plot.caption = element_text(size = 6),
      plot.background   = element_rect("#fafafa", "#fafafa"),
      panel.background  = element_rect("#fafafa"),
      panel.border = element_blank()
    )
)

rm(list=ls())
col <- RColorBrewer::brewer.pal(6,"Dark2")
```

```{r eval=FALSE, include=FALSE}
library(haven)
pp_1998_2012 <- read_dta("../data/pp_1998-2012.dta")
```

## Prepare Dataframe 
```{r eval=FALSE, include=FALSE}
df <- pp_1998_2012 %>%
  # decode variables
  mutate(p_group = to_character(p_group),
         medium = to_character(medium),
         wertung = as.numeric(remove_labels(wertung)),
         
         #Generate Date-Variable (as.Date function gives NAs)
         date = as.Date(datum, "%Y-%b-%d"),
         
         # Correct UTF Problems
         medium = factor(ifelse(grepl("ddeutsche", medium), "SZ", medium)),
         p_group = factor(ifelse(grepl("90", p_group), "Bündnis 90/ Die Grüne", p_group))
         )

### Assign category to medium
daily_print <- c("Die Welt", "F.A.Z.", "SZ", "Fr. Rundschau", "tageszeitung", "Bild", "Berliner")
magazine_print <- c("Focus", "Spiegel", "Die Zeit", "Die Woche", "Rh. Merkur", "Stern", "F.A.S.", "WamS", "BamS", "Super Illu")
news_tv <- c("Tagesthemen", "heute journal", "RTL Aktuell", "Tagesschau", "heute", "ProSieben", "Sat.1 News")
polit_tv <- c("Fakt", "Frontal 21", "Kontraste", "Monitor", "Panorama", "Plusminus", "Report (BR)", "Report (SWR)", "WISO", "Bericht aus Berlin", "Berlin direkt")

df <- df %>%
  mutate(category = ifelse(medium %in% daily_print, "daily_print", " "),
         category = ifelse(medium %in% magazine_print, "magazine_print", category),
         category = ifelse(medium %in% news_tv, "news_tv", category),
         category = ifelse(medium %in% polit_tv, "polit_tv", category))

save(df, file = "../output/mediatenorFULLDF.Rda")
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
df.collapsed <- df %>%
  select(date, medium, p_group, wertung, category) %>%
  group_by(date, medium, p_group, category) %>%
  summarise(obs = n(),
            wertung = mean(wertung, na.rm = T)) %>%
  ungroup()

save(df.collapsed, file = "../output/mediatenorCOLLAPSEDDF.Rda")
```

```{r include=FALSE}
load(file = "../output/mediatenorCOLLAPSEDDF.Rda")
```

# Clustering
```{r include=FALSE}
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
```


* techniques for finding subgroups of observations within a data set based on their similarity.
* unsupervised method: find relationships between the n observations without being trained by a response variable. 
* K-means clustering is the simplest and the most commonly used clustering method for splitting a dataset into a set of k groups.

## Data Preparation

To perform a cluster analysis in R, generally, the data should be prepared as follows:

  1. Rows are observations (individuals) and columns are variables.
  
  2. Any missing value in the data must be removed or estimated.
  
  3. The data must be standardized (i.e., scaled) to make variables comparable.
  
I group the data by medium & year to compute the mean value for each p_group:

```{r}
df.cluster <- 
  df.collapsed %>%
  filter(!p_group %in% c("Andere Parteien",
                         "Rechtsextreme Parteien",
                         "Linke/PDS/WASG")) %>%
  # mutate(
  #   #month = week(date),
  #        year = year(date)
  #       # yearweek = paste(as.character(year),
  #       #                  as.character(week)), sep="-"
  #       ) %>%
  group_by(medium, p_group) %>%
  summarise(wertung = mean(wertung, na.rm=T)) %>%
  ungroup() %>%
  spread(p_group, wertung) %>%
  mutate(id = medium)
  #mutate(id = paste(year, medium, sep = "/")) 


m.cluster <- as.matrix(df.cluster %>%
                         select(- c(medium, id)))
row.names(m.cluster) <- df.cluster$id
head(m.cluster)
```

```{r}
m.cluster <- na.omit(m.cluster)
```

## K-Means Clustering

K-means clustering is the most commonly used unsupervised machine learning algorithm for partitioning a given data set into a set of k groups (i.e. k clusters), where k represents the number of groups pre-specified by the analyst. It classifies objects in multiple groups (i.e., clusters), such that objects within the same cluster are as similar as possible (i.e., high intra-class similarity), whereas objects from different clusters are as dissimilar as possible (i.e., low inter-class similarity). In k-means clustering, each cluster is represented by its center (i.e, centroid) which corresponds to the mean of points assigned to the cluster.

### The Basic Idea

The basic idea behind k-means clustering consists of defining clusters so that the total intra-cluster variation (known as total within-cluster variation) is minimized. There are several k-means algorithms available. The standard algorithm is the Hartigan-Wong algorithm (1979), which defines the total within-cluster variation as the sum of squared distances Euclidean distances between items and the corresponding centroid:

$$
W(C_k)=\sum_{x_i\in C_k}(x_i-\mu_k)^2
$$
where:

  * $x_i$ is a data point belonging to Cluster $C_k$
  * $\mu_k$ is the mean value of the points assigned to the cluster $C_k$
  
Each observation ($x_i$) is assigned to a given cluster such that the sum of squares (SS) distance of the observation to their assigned cluster centers ($\mu_k$) is minimized.

The object function to be minimized is the **total within-cluster sum of square**:

$$
\text{tot.withiness} = \sum^k_{k=1}W(C_k)=\sum^k_{k=1}\sum_{x_i\in C_k}(x_i-\mu_k)^2
$$
### K-means Algorithm

K-means algorithm can be summarized as follows:

  1. Specify the number of clusters (K) to be created (by the analyst).
  
  2. Select randomly k objects from the data set as the initial cluster centers or means.
  
  3. Assigns each observation to their closest centroid, based on the Euclidean distance between the object and the centroid.
  
  4. For each of the k clusters update the cluster centroid by calculating the new mean values of all the data points in the cluster. The centroid of a $Kth$ cluster is a vector of length $p$ containing the means of all variables for the observations in the $kth$ cluster; $p$ is the number of variables.
  
  5. Iteratively minimize the total within sum of square (Equation above). That is, iterate steps 3 and 4 until the cluster assignments stop changing or the maximum number of iterations is reached. 

```{r}
k3<- kmeans(m.cluster, centers = 4, nstart = 25)
str(k3)
```

The output of *kmeans* is a list with several bits of information. The most important being:

  * cluster: A vector of integers (from 1:k) indicating the cluster to which each point is allocated.
  * centers: A matrix of cluster centers.
  * totss: The total sum of squares.
  * withinss: Vector of within-cluster sum of squares, one component per cluster.
  * tot.withinss: Total within-cluster sum of squares, i.e. sum(withinss).
  * betweenss: The between-cluster sum of squares, i.e. $totss-tot.withinss$.
  * size: The number of points in each cluster.

If we print the results we’ll see that our groupings resulted in 3 cluster sizes of 29, 49, 287. We see the cluster centers (means) for the three groups across the four variables (Bündnis 90/ Die Grüne, CDU/CSU, FDP, SPD). We also get the cluster assignment for each observation (i.e. BamS was assigned to cluster 3 in year 2001, Bericht aus Berlin was assigned to cluster 1 in 2005, etc.).

```{r}
k3
```

We can also view our results by using *fviz_cluster*. This provides a nice illustration of the clusters. If there are more than two dimensions (variables) *fviz_cluster* will perform principal component analysis (PCA) and plot the data points according to the first two principal components that explain the majority of the variance.

```{r}
fviz_cluster(k3, data = m.cluster, choose.vars = c("SPD","FDP"))
ggsave(file="cluster.png")
```

Alternatively, you can use standard pairwise scatter plots to illustrate the clusters compared to the original variables.

```{r}
fviz_cluster(k3, data = m.cluster, choose.vars = c("SPD","CDU/CSU"))
ggsave(file="cluster.png")
```


```{r fig.height=12, fig.width=12}
k2 <- kmeans(m.cluster, centers = 2, nstart = 25)
k3 <- kmeans(m.cluster, centers = 3, nstart = 25)
k4 <- kmeans(m.cluster, centers = 4, nstart = 25)
k5 <- kmeans(m.cluster, centers = 5, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, data = m.cluster) + ggtitle("k = 2")
p2 <- fviz_cluster(k3,  data = m.cluster) + ggtitle("k = 3")
p3 <- fviz_cluster(k4,  data = m.cluster) + ggtitle("k = 4")
p4 <- fviz_cluster(k5,  data = m.cluster) + ggtitle("k = 5")

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)

```

### Tageszeitungen

```{r}
df.cluster <- 
  df.collapsed %>%
  filter(!p_group %in% c("Andere Parteien",
                         "Rechtsextreme Parteien",
                         "Linke/PDS/WASG")) %>%
  filter(category == "daily_print") %>%
  mutate(
    #month = week(date),
         year = year(date)
        # yearweek = paste(as.character(year),
        #                  as.character(week)), sep="-"
        ) %>%
  group_by(medium, p_group, year) %>%
  summarise(wertung = mean(wertung, na.rm=T)) %>%
  ungroup() %>%
  spread(p_group, wertung) %>%
  mutate(id = paste(year, medium, sep = "/")) 


m.cluster <- as.matrix(df.cluster %>%
                         select(- c(medium, year, id)))
row.names(m.cluster) <- df.cluster$id
head(m.cluster)
```

```{r}
m.cluster <- na.omit(m.cluster)
```

#### K-Means Clustering

```{r fig.height=12, fig.width=12}
k2 <- kmeans(m.cluster, centers = 2, nstart = 25)
k3 <- kmeans(m.cluster, centers = 3, nstart = 25)
k4 <- kmeans(m.cluster, centers = 4, nstart = 25)
k5 <- kmeans(m.cluster, centers = 5, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, data = m.cluster) + ggtitle("k = 2")
p2 <- fviz_cluster(k3,  data = m.cluster) + ggtitle("k = 3")
p3 <- fviz_cluster(k4,  data = m.cluster) + ggtitle("k = 4")
p4 <- fviz_cluster(k5,  data = m.cluster) + ggtitle("k = 5")

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)

```

### Nachrichtensendungen

```{r echo=FALSE}
df.cluster <- 
  df.collapsed %>%
  filter(!p_group %in% c("Andere Parteien",
                         "Rechtsextreme Parteien",
                         "Linke/PDS/WASG")) %>%
  filter(category == "news_tv") %>%
  mutate(
    #month = week(date),
         year = year(date)
        # yearweek = paste(as.character(year),
        #                  as.character(week)), sep="-"
        ) %>%
  group_by(medium, p_group, year) %>%
  summarise(wertung = mean(wertung, na.rm=T)) %>%
  ungroup() %>%
  spread(p_group, wertung) %>%
  mutate(id = paste(year, medium, sep = "/")) 


m.cluster <- as.matrix(df.cluster %>%
                         select(- c(medium, year, id)))
row.names(m.cluster) <- df.cluster$id
```

```{r}
m.cluster <- na.omit(m.cluster)
```

#### K-Means Clustering

```{r fig.height=12, fig.width=12}
k2 <- kmeans(m.cluster, centers = 2, nstart = 25)
k3 <- kmeans(m.cluster, centers = 3, nstart = 25)
k4 <- kmeans(m.cluster, centers = 4, nstart = 25)
k5 <- kmeans(m.cluster, centers = 5, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, data = m.cluster) + ggtitle("k = 2")
p2 <- fviz_cluster(k3,  data = m.cluster) + ggtitle("k = 3")
p3 <- fviz_cluster(k4,  data = m.cluster) + ggtitle("k = 4")
p4 <- fviz_cluster(k5,  data = m.cluster) + ggtitle("k = 5")

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)

```

### Magazine und Wochenzeitungen

```{r echo=FALSE}
df.cluster <- 
  df.collapsed %>%
  filter(!p_group %in% c("Andere Parteien",
                         "Rechtsextreme Parteien",
                         "Linke/PDS/WASG")) %>%
  filter(category == "magazine_print") %>%
  mutate(
    #month = week(date),
         year = year(date)
        # yearweek = paste(as.character(year),
        #                  as.character(week)), sep="-"
        ) %>%
  group_by(medium, p_group, year) %>%
  summarise(wertung = mean(wertung, na.rm=T)) %>%
  ungroup() %>%
  spread(p_group, wertung) %>%
  mutate(id = paste(year, medium, sep = "/")) 


m.cluster <- as.matrix(df.cluster %>%
                         select(- c(medium, year, id)))
row.names(m.cluster) <- df.cluster$id
```

```{r}
m.cluster <- na.omit(m.cluster)
```

#### K-Means Clustering

```{r fig.height=12, fig.width=12}
k2 <- kmeans(m.cluster, centers = 2, nstart = 25)
k3 <- kmeans(m.cluster, centers = 3, nstart = 25)
k4 <- kmeans(m.cluster, centers = 4, nstart = 25)
k5 <- kmeans(m.cluster, centers = 5, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, data = m.cluster) + ggtitle("k = 2")
p2 <- fviz_cluster(k3,  data = m.cluster) + ggtitle("k = 3")
p3 <- fviz_cluster(k4,  data = m.cluster) + ggtitle("k = 4")
p4 <- fviz_cluster(k5,  data = m.cluster) + ggtitle("k = 5")

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)

```

### Politische Sendungen

```{r echo=FALSE}
df.cluster <- 
  df.collapsed %>%
  filter(!p_group %in% c("Andere Parteien",
                         "Rechtsextreme Parteien",
                         "Linke/PDS/WASG")) %>%
  filter(category == "polit_tv") %>%
  mutate(
    #month = week(date),
         year = year(date)
        # yearweek = paste(as.character(year),
        #                  as.character(week)), sep="-"
        ) %>%
  group_by(medium, p_group, year) %>%
  summarise(wertung = mean(wertung, na.rm=T)) %>%
  ungroup() %>%
  spread(p_group, wertung) %>%
  mutate(id = paste(year, medium, sep = "/")) 


m.cluster <- as.matrix(df.cluster %>%
                         select(- c(medium, year, id)))
row.names(m.cluster) <- df.cluster$id
```

```{r}
m.cluster <- na.omit(m.cluster)
```

#### K-Means Clustering

```{r fig.height=12, fig.width=12}
k2 <- kmeans(m.cluster, centers = 2, nstart = 25)
k3 <- kmeans(m.cluster, centers = 3, nstart = 25)
k4 <- kmeans(m.cluster, centers = 4, nstart = 25)
k5 <- kmeans(m.cluster, centers = 5, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, data = m.cluster) + ggtitle("k = 2")
p2 <- fviz_cluster(k3,  data = m.cluster) + ggtitle("k = 3")
p3 <- fviz_cluster(k4,  data = m.cluster) + ggtitle("k = 4")
p4 <- fviz_cluster(k5,  data = m.cluster) + ggtitle("k = 5")

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)

```